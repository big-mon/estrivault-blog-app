---
import { buildUrl } from "../../../../packages/cloudinary-utils/index.ts";
// cloudNameを環境変数から取得してbuildUrlに渡す
const cloudName = import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME;
if (!cloudName) {
  throw new Error("Missing Cloudinary cloud name in environment");
}

const {
  publicId,
  alt = "",
  widths = [480, 768, 1024, 1200],
  aspectRatio,
  className = "",
  mode = "fill", // "fill" | "fit"
} = Astro.props;

function buildSrcSet() {
  return widths
    .map((w: number) => {
      const h =
        aspectRatio && mode === "fill"
          ? Math.round(w / aspectRatio)
          : undefined;
      return `${buildUrl(cloudName, publicId, { w, h, mode })} ${w}w`;
    })
    .join(", ");
}

const fallbackWidth = Math.max(...widths);
const fallbackHeight =
  aspectRatio && mode === "fill"
    ? Math.round(fallbackWidth / aspectRatio)
    : undefined;
const src = buildUrl(cloudName, publicId, {
  w: fallbackWidth,
  h: fallbackHeight,
  mode,
});
const srcset = buildSrcSet();
---

<img
  src={src}
  srcset={srcset}
  sizes="100vw"
  width={fallbackWidth}
  height={fallbackHeight}
  alt={alt}
  class={className}
  loading="lazy"
/>
