# content-processor リファクタリング計画 v2

## 現在のコードベースの分析

### 主要コンポーネント

1. **`index.ts`** - メインエクスポート
   - Markdown処理のエントリーポイント
   - ファイル操作と文字列処理の両方を提供
   - 投稿一覧の取得とフィルタリング

2. **`pipeline.ts`** - Markdown変換パイプライン
   - Unified.jsを使用したMarkdown→HTML変換
   - 複数のremark/rehypeプラグインを統合
   - セキュリティ対策（サニタイズ）

3. **`plugins/`** - カスタム変換プラグイン
   - 画像変換
   - 外部サービス埋め込み（YouTube, Twitter, GitHub, Amazon）
   - リンク変換

4. **`utils/`** - ユーティリティ関数
   - パス操作
   - その他のヘルパー関数

## リファクタリング方針

### 1. ディレクトリ構造の再編

```
src/
├── core/                      # コアなビジネスロジック
│   ├── markdown/              # Markdown関連
│   │   ├── processor.ts       # 変換パイプラインの構築
│   │   ├── transformer.ts     # 変換ロジック
│   │   └── frontmatter.ts     # フロントマター処理
│   └── models/                # ドメインモデル
│       └── post.ts            # 投稿関連の型定義
│
├── services/                # ドメインサービス
│   ├── post-service.ts        # 投稿関連のビジネスロジック
│   └── file-service.ts        # ファイルシステム操作
│
├── plugins/                  # 変換プラグイン
│   ├── embeds/               # 埋め込み関連
│   │   ├── youtube.ts
│   │   ├── twitter.ts
│   │   ├── github.ts
│   │   └── amazon.ts
│   └── transforms/           # 変換関連
│       ├── image.ts
│       └── link.ts
│
├── utils/                   # ユーティリティ関数
│   ├── image-utils.ts        # 画像関連
│   ├── path-utils.ts         # パス操作
│   └── validation.ts         # バリデーション
│
├── types/                   # 型定義
│   └── index.ts
│
└── index.ts                 # パブリックAPIのエクスポート
```

### 2. 主要な変更点

#### 2.1 コアモジュールの整理
- **`core/markdown/processor.ts`** (旧 `pipeline.ts`)
  - 変換パイプラインの構築と管理
  - プラグインの登録
  - セキュリティ設定

- **`core/markdown/transformer.ts`** (新規)
  - `loadFromString` の実装
  - エラーハンドリング
  - メタデータの構築

- **`core/markdown/frontmatter.ts`** (新規)
  - フロントマターのバリデーション
  - デフォルト値の設定
  - 型変換

#### 2.2 サービスの分離
- **`services/post-service.ts`**
  - 投稿の取得・検索・フィルタリング
  - ページネーション
  - キャッシュ管理

- **`services/file-service.ts`**
  - ファイルの読み書き
  - ファイルの存在確認
  - ディレクトリ走査

#### 2.3 プラグインの整理
- プラグインを機能ごとに分類
- 各プラグインは独立してテスト可能に
- プラグイン間の依存関係を明確化

### 3. リファクタリング手順

#### フェーズ1: 準備
1. 新しいディレクトリ構造を作成
2. テスト環境のセットアップ
3. 既存のテストが通ることを確認

#### フェーズ2: コアモジュールのリファクタリング
1. `pipeline.ts` を `core/markdown/processor.ts` に移動・リファクタリング
2. 変換ロジックを `transformer.ts` に分離
3. フロントマター処理を `frontmatter.ts` に分離

#### フェーズ3: プラグインの整理
1. プラグインを機能ごとに分類
2. 各プラグインを独立したモジュールに分割
3. プラグインのテストを整備

#### フェーズ4: サービスのリファクタリング
1. `post-service.ts` の実装
2. `file-service.ts` の実装
3. サービスレイヤーのテストを整備

#### フェーズ5: 統合と最適化
1. モジュール間の連携を確認
2. パフォーマンスの検証
3. ドキュメンテーションの更新

### 4. 注意点

- **後方互換性**
  - 既存の公開APIは維持
  - 非推奨の警告を適切に表示

- **テスト戦略**
  - 各モジュールの単体テスト
  - 統合テストの充実
  - パフォーマンステストの実施

- **ドキュメンテーション**
  - パブリックAPIのドキュメント
  - アーキテクチャの説明
  - 開発者向けガイド

### 5. 期待される効果

- **保守性の向上**
  - 関心の分離が明確に
  - コードの見通しが向上
  - バグの発見・修正が容易に

- **拡張性の向上**
  - プラグインの追加・変更が容易に
  - 新しい機能の追加がスムーズに
  - テストの追加・実行が容易に

- **パフォーマンスの最適化**
  - 不要な処理の削減
  - キャッシュ戦略の最適化
  - 並列処理の可能性の検討
