# ✅ コンテンツ変換ライブラリ「content-processor」要件定義

## 1. 目的（ゴール）

SvelteKit ベースのブログ／任意の Node ツールから再利用できる **Markdown→HTML 変換ライブラリ** を提供する。ブログ記事に必要な Front‑matter 抽出・独自ディレクティブ拡張・安全な HTML 生成を 1 パッケージに統合し、Mono‑repo 内外から呼び出せるようにする。

## 2. スコープ

| 範囲      | 含まれる内容                                                                                                                                                                                                                                                                              |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ✅ 対象   | Markdown ファイルまたは文字列入力の受け取り<br>Front‑matter（title / date / tags …）抽出<br>カスタムディレクティブ（YouTube / Twitter / GitHub / Amazon）の HTML 変換<br>リンク・画像の内部/外部変換<br>HTML サニタイズ<br>記事一覧 API (`getAllPosts`)<br>記事詳細 API (`getPostBySlug`) |
| ❌ 非対象 | CMS 連携／DB ストレージ<br>コメント機能<br>サイトマップ・RSS 生成（フェーズ 2 で検討）                                                                                                                                                                                                    |

## 3. 機能要件

| ID  | 要件                                                                                      | 優先度 |
| --- | ----------------------------------------------------------------------------------------- | ------ |
| F‑1 | **Markdown 文字列 or ファイルパス** を入力として受け取り、Front‑matter と本文を分離できる | ★★★    |
| F‑2 | `::youtube{id="…"}` 等の独自ディレクティブを HTML 要素へ変換できる                        | ★★★    |
| F‑3 | リンクが外部 URL の場合 `target="_blank" rel="noopener noreferrer"` を自動付与できる      | ★★☆    |
| F‑4 | 相対画像パスを Cloudinary CDN URL に変換できる（環境変数でドメイン指定）                  | ★★☆    |
| F‑5 | 変換結果の HTML を rehype‑sanitize で安全化できる                                         | ★★★    |
| F‑6 | 記事一覧を日付降順で取得できる                                                            | ★★★    |
| F‑7 | 読了時間（分）を自動計算して meta に含める                                                | ★★☆    |

## 4. 非機能要件

| 区分           | 要件                                                |
| -------------- | --------------------------------------------------- |
| パフォーマンス | ビルド時のみ実行。ランタイム変換は 100ms 以内。     |
| セキュリティ   | iframe／script を許可せず、whitelist タグのみ残す。 |
| テスト         | Vitest で 100% 分岐カバー。                         |
| 拡張性         | remark / rehype プラグインをオプションで追加可能。  |
| 互換性         | Node 18+ / ESM。Cloudflare Workers で動作確認。     |

## 5. Phase 分割

1. **MVP** : Front‑matter 抽出 + YouTube ディレクティブ + HTML 出力
2. Twitter / GitHub / Amazon ディレクティブ追加
3. 画像 CDN 変換 + RSS/Sitemap エクスポーター
