# 🗂 コンテンツ変換ライブラリ「content-processor」

## ディレクトリ構成ドキュメント

> **目的** : Mono-repo 内での配置・ビルド手順・依存の境界を明確にし、開発者が迷わずコントリビュートできる状態を作る。

---

## 1. ルートレベル

```text
pnpm-workspace.yaml      # ワークスペース定義
package.json             # ルート dev ツールだけ (eslint, prettier, vitest)
configs/                 # 共通設定 (tsconfig.base.json, eslint, tsup)
```

### ルート `package.json` 例 (抜粋)

```jsonc
{
  "private": true,
  "workspaces": ["apps/*", "packages/*"],
  "scripts": {
    "build": "pnpm -r build",
    "test": "pnpm -r test"
  },
  "devDependencies": {
    "eslint": "^8.0.0",
    "tsup": "^7.2.0",
    "vitest": "^1.0.0"
  }
}
```

---

## 2. apps/ フォルダー

```text
apps/
└─ svelte-blog/          # ブログ本体 (SvelteKit)
   ├─ src/
   ├─ static/
   ├─ svelte.config.js
   └─ package.json        # app 固有依存 (content-processor はここで install)
```

- **依存ポリシー** : アプリ側は `content-processor` と必要な embed プラグインだけを `dependencies` に持つ。

---

## 3. packages/ フォルダー

```text
packages/
│
├─ content-processor/         # ★コアライブラリ
│   ├─ src/
│   │   ├─ index.ts           # public API
│   │   ├─ pipeline.ts        # unified() ビルダー
│   │   ├─ types.ts           # PostMeta 型など
│   │   └─ plugins/
│   │       ├─ link-transform.ts
│   │       └─ image-transform.ts
│   ├─ test/                  # Vitest cases
│   ├─ tsconfig.json
│   └─ package.json
│
├─ remark-embed-youtube/
│   └─ src/index.ts
├─ remark-embed-twitter/
├─ remark-embed-github/
└─ remark-embed-amazon/
```

### ポイント

| ディレクトリ           | 役割                                      | build              | publish                                      |
| ---------------------- | ----------------------------------------- | ------------------ | -------------------------------------------- |
| **content-processor**  | Front-matter 抽出 & HTML 生成             | `tsup` で ESM 出力 | npm: `@estrivault/content-processor`         |
| **remark-embed-\* 系** | 個別ディレクティブ → `<Component />` 変換 | 各自 `tsup`        | npm: `@estrivault/remark-embed-youtube` など |

> **meta パッケージ** を作る場合は `remark-embed-all` を sibling に配置し、依存として 4 つを要求。

---

## 4. 共通 tsconfig & ESLint

```
configs/
├─ tsconfig.base.json  # "paths": { "@/*": ["packages/*/src"] }
└─ eslint.base.js      # import/no-extraneous-dependencies → workspace ルール
```

各パッケージの `tsconfig.json` は

```jsonc
{
  "extends": "../../configs/tsconfig.base.json",
  "compilerOptions": {
    "outDir": "dist",
    "rootDir": "src"
  },
  "include": ["src"]
}
```

---

## 5. ビルド & 発行フロー

1. **開発** : `pnpm dev` (SvelteKit) → `content-processor` が src 参照で即反映
2. **テスト** : `pnpm test` ルートで全パッケージの Vitest 実行
3. **ビルド** : `pnpm build` → 各パッケージ `dist/` 作成
4. **リリース** : Changesets → `pnpm changeset version && pnpm -r publish`

---

## 6. 依存関係ガイドライン

- **アプリ → ライブラリ** 方向のみ。ライブラリ同士は **横依存しない**（循環回避）
- 共通ユーティリティが必要な場合は `packages/@utils/*` にまとめる
- 外部 OSS は **ライブラリ側で peerDependencies** にしてアプリに解決させる
