# ⚙️ 技術選定ドキュメント — content-processor

> **狙い** : なぜこのライブラリ群・ツールチェーンを採用するかを明文化し、後続メンバーが判断理由を追跡できるようにする。

---

## 1. 言語・ターゲット

| レイヤ           | 採用                         | 理由                                  |
| ---------------- | ---------------------------- | ------------------------------------- |
| ソースコード     | **TypeScript 5.x (ES2022)**  | 型安全・エディタ支援・チーム標準      |
| 出力フォーマット | **ESM +  型定義**            | Node 18 以降 & バンドラーで汎用利用可 |
| 実行環境         | Node 18 / Cloudflare Workers | Cloud 基盤（Vercel・CF Pages）両対応  |

---

## 2. 核心ライブラリ

| 目的               | 採用                                     | 採用理由                                     | 主な代替 & 非採用理由                          |
| ------------------ | ---------------------------------------- | -------------------------------------------- | ---------------------------------------------- |
| Front‑matter 抽出  | **gray-matter**                          | 速度・型・メンテ実績 ◎                       | `yaml-front-matter`…本文パースに別 lib が必要  |
| Markdown 解析      | **unified / remark-parse**               | AST で全て制御可能、エコシステム最大         | `marked`, `markdown-it`…プラグイン生態系が弱い |
| ディレクティブ解析 | **remark-directive**                     | YAML 的 attr を柔軟に扱える                  | コードフェンス方式だと attr 拡張が面倒         |
| HTML 変換          | **remark-rehype** → **rehype-stringify** | AST→HTML まで一気通貫                        | `rehype-markdown` …逆方向 ／ フレーバ不足      |
| HTML 安全化        | **rehype-sanitize**                      | allowlist 方式で XSS 回避                    | DOMPurify…ブラウザ前提で Node 版は重い         |
| 生 HTML 解釈       | **rehype-raw**                           | ディレクティブで生成した `<YouTube…>` を解析 | なし (必須)                                    |
| 読了時間計算       | **reading-time**                         | 2kB・実装単純                                | 独自実装だとメンテ無駄                         |

---

## 3. 自作プラグイン

| パッケージ                                  | 目的　　　　　　　　　　　　　             | API 備考                         |
| ------------------------------------------- | ------------------------------------------ | -------------------------------- |
| `@estrivault/remark-embed-youtube`          | `::youtube{id="…"}` → `<YouTube id="…" />` | peerDep : remark-directive       |
| `...-twitter` / `...-github` / `...-amazon` | 同上                                       | —                                |
| `@estrivault/remark-link-transform`         | 外部リンク自動 `target="_blank"`           | internalPredicate option         |
| `@estrivault/remark-image-transform`        | 相対パス → CDN URL 変換                    | baseUrl / width / quality option |

> **方針** : “プラグイン 1 役 1 責任”。将来 OSS 配布／他プロジェクト流用を見据え **個別パッケージ化**。

---

## 4. ビルド・テスト・CI

| 項目    | 採用                               | 理由                                                 |
| ------- | ---------------------------------- | ---------------------------------------------------- |
| Bundler | **tsup (esbuild)**                 | 高速・設定 1 行・型定義 out 可                       |
| テスト  | **Vitest**                         | Vite ベース & mono-repo で高速並列                   |
| Lint    | **ESLint + eslint-plugin-unified** | remark AST 用 ESLint ルールを共有                    |
| CI      | **GitHub Actions**                 | Node 18/20 Matrix + `pnpm -r test` + `pnpm -r build` |
| Publish | **Changesets**                     | パッケージ単位で semver & リリースノート自動         |

---

## 5. 代替案ボツ理由メモ

- **MDX/mdsvex 単独採用** … 埋め込みは楽だが _GitHub プレビュー不可視化 & SSG サイズ増_。
- **`@astrojs/markdown-remark`** … Astro 前提なので SvelteKit/CLI で再利用しづらい。
- **Monolithic embed plugin** … 4 種一体だと Tree‑shaking が効かず将来の OSS 配布で不便。

---

## 6. 今後追加検討ライブラリ

- `rehype-pretty-code` : Shiki ベース code highlight (phase‑2)
- `@pagefind/default-ui` : 静的検索インデックス生成
- `rehype-autolink-headings` : 見出しリンク自動付与
